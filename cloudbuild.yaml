# Cloud Build Configuration for Automated CI/CD
# Triggers on push to main branch

substitutions:
  _REGION: australia-southeast1  # Sydney, Australia
  _BACKEND_SERVICE: backend
  _FRONTEND_SERVICE: frontend
  _BACKEND_IMAGE: australia-southeast1-docker.pkg.dev/sadaai-dashboard/sadaai-docker/backend
  _FRONTEND_IMAGE: australia-southeast1-docker.pkg.dev/sadaai-dashboard/sadaai-docker/frontend

steps:
  # Step 1: Build Backend Docker Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-backend'
    args:
      - 'build'
      - '-t'
      - '${_BACKEND_IMAGE}:${COMMIT_SHA}'
      - '-t'
      - '${_BACKEND_IMAGE}:latest'
      - './backend'
    waitFor: ['-']

  # Step 2: Push Backend Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-backend'
    args:
      - 'push'
      - '--all-tags'
      - '${_BACKEND_IMAGE}'
    waitFor: ['build-backend']

  # Step 3: Build Frontend Docker Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-frontend'
    args:
      - 'build'
      - '--build-arg'
      - 'NEXT_PUBLIC_API_URL=https://backend-placeholder.run.app'
      - '-t'
      - '${_FRONTEND_IMAGE}:${COMMIT_SHA}'
      - '-t'
      - '${_FRONTEND_IMAGE}:latest'
      - './frontend'
    waitFor: ['-']

  # Step 4: Push Frontend Image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-frontend'
    args:
      - 'push'
      - '--all-tags'
      - '${_FRONTEND_IMAGE}'
    waitFor: ['build-frontend']

  # Step 5: Deploy Backend to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-backend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_BACKEND_SERVICE}'
      - '--image'
      - '${_BACKEND_IMAGE}:${COMMIT_SHA}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '10'
      - '--memory'
      - '512Mi'
      - '--cpu'
      - '1'
      - '--port'
      - '3001'
      - '--add-cloudsql-instances'
      - 'sadaai-dashboard:${_REGION}:sadaai-db'
      - '--update-secrets'
      - 'DATABASE_URL=DATABASE_URL:latest,JWT_SECRET=JWT_SECRET:latest,JWT_REFRESH_SECRET=JWT_REFRESH_SECRET:latest,REDIS_HOST=REDIS_HOST:latest,NEXTAUTH_SECRET=NEXTAUTH_SECRET:latest'
      - '--update-env-vars'
      - 'NODE_ENV=production,PORT=3001,FRONTEND_URL=https://frontend-placeholder.run.app'
    waitFor: ['push-backend']

  # Step 6: Deploy Frontend to Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-frontend'
    entrypoint: gcloud
    args:
      - 'run'
      - 'deploy'
      - '${_FRONTEND_SERVICE}'
      - '--image'
      - '${_FRONTEND_IMAGE}:${COMMIT_SHA}'
      - '--region'
      - '${_REGION}'
      - '--platform'
      - 'managed'
      - '--allow-unauthenticated'
      - '--min-instances'
      - '0'
      - '--max-instances'
      - '10'
      - '--memory'
      - '512Mi'
      - '--cpu'
      - '1'
      - '--port'
      - '3000'
      - '--update-env-vars'
      - 'NODE_ENV=production,NEXT_PUBLIC_API_URL=https://backend-placeholder.run.app'
    waitFor: ['push-frontend']

# Build timeout (20 minutes)
timeout: '1200s'

# Build logs configuration
options:
  logging: LEGACY
  machineType: 'E2_HIGHCPU_8'

# Images to be pushed to Artifact Registry
images:
  - '${_BACKEND_IMAGE}:${COMMIT_SHA}'
  - '${_BACKEND_IMAGE}:latest'
  - '${_FRONTEND_IMAGE}:${COMMIT_SHA}'
  - '${_FRONTEND_IMAGE}:latest'
